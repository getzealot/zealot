#!/bin/sh

cd $(dirname $0)/..
app_root=$(pwd)
cd $app_root/..
shared_root=$(pwd)/shared
cd $app_root

sidekiq_pidfile="$shared_root/tmp/pids/sidekiq-0.pid"
sidekiq_logfile="$shared_root/log/sidekiq.log"
app_user=$(ls -l config.ru | awk '{print $3}')

sidekiq_cmd="bundle exec sidekiq --index 0 --pidfile $sidekiq_pidfile --environment $RAILS_ENV"

warn()
{
  echo "$@" 1>&2
}

stop()
{
  exec bundle exec sidekiqctl stop $sidekiq_pidfile 10 >> $sidekiq_logfile 2>&1
}

killall()
{
  pkill -u $app_user -f 'sidekiq [0-9]'
}

restart()
{
  if [ -f $sidekiq_pidfile ]; then
    stop
  fi
  killall
  exec $sidekiq_cmd --logfile $sidekiq_logfile --daemon
}

start_no_daamonize()
{
  start_sidekiq >> $sidekiq_logfile 2>&1
}

start_sidekiq()
{
  exec $sidekiq_cmd
}

load_ok()
{
  sidekiq_pid=$(cat $sidekiq_pidfile)
  if [ -z "$sidekiq_pid" ] ; then
    warn "Could not find a PID in $sidekiq_pidfile"
    exit 0
  fi

  if (ps -p $sidekiq_pid -o args | grep '\([0-9]\+\) of \1 busy' 1>&2) ; then
    warn "Too many busy Sidekiq workers"
    exit 1
  fi

  exit 0
}

case "$1" in
  stop)
    stop
    ;;
  start)
    restart
    ;;
  start_no_daamonize)
    start_no_daamonize
    ;;
  start_foreground)
    start_sidekiq
    ;;
  restart)
    restart
    ;;
  killall)
    killall
    ;;
  load_ok)
    load_ok
    ;;
  *)
    echo "Usage: RAILS_ENV=your_env $0 {stop|start|start_no_daamonize|restart|killall|load_ok}"
esac
